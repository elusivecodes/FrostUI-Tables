!function(t,e){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e:e(t)}(window,(function(t){"use strict";if(!t)throw new Error("FrostUI-Tables requires a Window.");if(!("UI"in t))throw new Error("FrostUI-Tables requires FrostUI.");const e=t.Core,s=t.dom,i=(t.QuerySet,t.UI);t.document;class n extends i.BaseComponent{constructor(t,s){let i;super(t,s),this._data=[],this._getData=null,this._getResults=null,e.isFunction(this._settings.getResults)?(this._getResultsCallbackInit(),this._getResultsInit()):i=e.isArray(this._settings.data)?this._settings.data:this.constructor._getDataFromDOM(this._node),i&&(this._data=i,this._getDataInit()),this._headings=this.constructor._getHeadingsFromDOM(this._node),this._columns=[],this._settings.columns?this._columns=this._settings.columns:this._columns=new Array(this._headings.length).fill(),this._columns=this._columns.map(t=>({dir:"asc",key:null,orderData:null,orderable:!0,searchable:!0,visible:!0,...t})),this._columnCount=this._columns.reduce((t,e)=>(e.visible&&t++,t),0),this._offset=0,this._limit=this._settings.length,this._order=this._settings.order.slice(),this._term=null,this._data&&this._buildIndex(),this._render(),this._events(),this._getData()}destroy(){super.destroy()}}Object.assign(n.prototype,{_events(){this._settings.lengthChange&&s.addEvent(this._lengthSelect,"change",t=>{const e=s.getValue(t.currentTarget);this._limit=e,this._getData()}),this._settings.searching&&s.addEvent(this._searchInput,"input",t=>{this._term=s.getValue(t.currentTarget),this._getData()}),this._settings.ordering&&s.addEventDelegate(this._thead,"click","th",t=>{t.preventDefault();const e=s.index(t.currentTarget);if(!this._columns[e].orderable)return;const i=this._columns[e].dir;let n=null;for(const[t,s]of this._order)if(t==e){n=s;break}let a=i;n===i&&(a="asc"===i?"desc":"asc"),t.shiftKey?n?this._order=n===i?this._order.map(([t,s])=>(t==e&&(s=a),[t,s])):this._order.filter(([t])=>t!=e):this._order.push([e,a]):this._order=[[e,a]],this._getData()}),this._settings.paging&&s.addEventDelegate(this._pagination,"click","[data-page]",t=>{const e=s.getDataset(t.currentTarget,"page");this._offset=(e-1)*this._limit,this._getData()})}}),Object.assign(n.prototype,{_buildIndex(){this._index=[];for(const[t,e]of this._columns.entries()){if(!e.orderable)return!1;const s=e.key||t;this._index[s]=[];const i={};for(const[t,e]of this._data.entries()){const n=e[s];n in i||(i[n]=[]),i[n].push(t)}const n=Object.keys(i).sort((t,e)=>{const s=t.match(/^(.*?)(\d+)$/),i=e.match(/^(.*?)(\d+)$/);if(s&&i&&s[1]===i[1])return s[2]-i[2];const n=t.toLowerCase(),a=e.toLowerCase();return n.localeCompare(a)});for(const t of n)this._index[s].push(i[t])}},_getOrderedIndexes(t=null,e=this._offset,s=this._limit,i=0){const[n,a]=this._order[i],r=this._columns[n].key||n;let o=this._index[r];"desc"===a&&(o=o.slice().reverse());let l=0;const h=[];for(const n of o){let r=t?n.filter(e=>t.includes(e)):n;if("desc"===a&&(r=r.slice().reverse()),e>l+r.length||!r.length){l+=n.length;continue}const o=r.length>1&&i<this._order.length-1?this._getOrderedIndexes(r,0,Math.min(r.length,s-h.length),i+1):n;for(const t of o)if(l++,!(l<e)&&(h.push(t),h.length==s))return h}return h}}),Object.assign(n.prototype,{_getDataInit(){this._getData=t=>{const s=this._data.length;let i=s,n=null;if(this._term){n=[];const t=e.escapeRegExp(this._term),s=new RegExp(t,"i"),a=this._term.normalize("NFD").replace(/[\u0300-\u036f]/g,""),r=e.escapeRegExp(a),o=new RegExp(r,"i");for(const[t,e]of this._data.entries())for(const[i,a]of this._columns.entries()){if(!a.searchable)continue;const r=a.key||i;(s.test(e[r])||o.test(e[r]))&&n.push(t)}i=n.length}this._settings.ordering&&(n=this._getOrderedIndexes(n));let a=[];if(n)for(const t of n)a.push(this._data[t]);else a=this._data.slice(this._offset,this._offset+this._limit);this._renderResults({filtered:i,results:a,total:s,rowIndexes:n})}},_getResultsInit(){this._getData=t=>{this._request&&this._request.cancel&&(this._request.cancel(),this._request=null);const e={};this._term&&(e.term=this._term),this._settings.ordering&&(e.order=this._order),this._settings.paging&&(e.offset=this._offset,e.limit=this._limit),s.show(this._loader);const i=this._getResults(e);i.then(t=>{this._renderResults(t)}).catch(t=>{}).finally(t=>{s.hide(this._loader),this._request===i&&(this._request=null)})}},_getResultsCallbackInit(){this._getResults=t=>{const e=this._settings.getResults(t);return this._request=Promise.resolve(e),this._request.then(t=>(this._data=t.results,t)),this._request}}}),Object.assign(n.prototype,{_render(){this._tfoot=s.findOne("tfoot",this._node),s.detach(this._tfoot),s.empty(this._node),this._container=s.create("div",{class:"position-relative mb-2"}),s.before(this._node,this._container),this._loader=s.create("div",{class:"position-absolute top-50 start-50 translate-middle"});const t=s.create("span",{class:"spinner-border text-primary"});s.append(this._loader,t);const e=s.create("div",{class:"d-sm-flex justify-content-between mb-2"});this._preCol1=s.create("div"),s.append(e,this._preCol1),this._preCol2=s.create("div"),s.append(e,this._preCol2),this._thead=s.create("thead"),s.append(this._node,this._thead),this._tbody=s.create("tbody"),s.append(this._node,this._tbody),s.append(this._node,this._tfoot);const i=s.create("div",{class:"d-sm-flex justify-content-between"});this._postCol1=s.create("div"),s.append(i,this._postCol1),this._postCol2=s.create("div"),s.append(i,this._postCol2);const n=s.create("div",{class:"d-flex"});s.append(this._postCol2,n),this._pagination=s.create("div",{class:"pagination pagination-sm mx-auto me-sm-0"}),s.append(n,this._pagination),this._settings.searching&&this._renderSearch(),this._settings.lengthChange&&this._renderLengthSelect(),s.hide(this._loader),s.append(this._container,this._loader),s.append(this._container,e),s.append(this._container,this._node),s.append(this._container,i)},_renderHeadings(){s.empty(this._thead);const t=s.create("tr");for(const[e,i]of this._headings.entries()){if(!this._columns[e].visible)continue;const n=s.create("th",{class:"table-heading",html:i});if(s.append(t,n),!this._settings.ordering||!this._columns[e].orderable)continue;let a="table-sort";for(const t of this._order)t[0]==e&&("asc"==t[1]?a+=" table-sort-asc":a+=" table-sort-desc");s.addClass(n,a)}s.append(this._thead,t)},_renderInfo(t){s.empty(this._postCol1);const e=s.create("div",{class:"text-center text-sm-start mb-1 mb-sm-0"}),i=this._offset+1,n=this._offset+t.results.length;let a=`Showing results ${i} to ${n} of ${t.filtered}.`;this._settings.infoCallback&&(a=this._settings.infoCallback(i,n,t.total,t.filtered,r));const r=s.create("small",{text:a});s.append(e,r),s.append(this._postCol1,e)},_renderLengthSelect(){const t=s.create("div",{class:"d-flex justify-content-center justify-content-sm-start"}),e=s.create("label",{class:"mb-1 mb-sm-0"});s.append(t,e);const i=s.create("small",{class:"me-1",text:"Show"});s.append(e,i);const n=s.create("div",{class:"form-input d-inline-block",style:{width:"initial"}});s.append(e,n),this._lengthSelect=s.create("select",{class:"input-filled input-sm"}),s.append(n,this._lengthSelect);for(const t of this._settings.lengths){const e=s.create("option",{value:t,text:t});t==this._limit&&s.setAttribute(e,"checked",!0),s.append(this._lengthSelect,e)}const a=s.create("div",{class:"ripple-line"});s.append(n,a);const r=s.create("small",{class:"ms-1",text:"results"});s.append(e,r),s.append(this._preCol1,t)},_renderPageItem(t){const e=s.create("div",{class:"page-item"}),i=s.create("button",{class:"page-link ripple",attributes:{type:"button"}});if(s.append(e,i),t.disabled&&(s.addClass(e,"disabled"),s.setAttribute(i,"aria-disabled","true"),s.setAttribute(i,"tabindex","-1")),t.active&&s.addClass(e,"active"),t.icon){const e=s.create("span",{class:t.icon});s.append(i,e)}else s.setText(i,t.page);return t.page&&s.setDataset(i,"page",t.page),e},_renderPagination(t){const e=Math.ceil(t.filtered/this._limit),i=1+this._offset/this._limit;s.empty(this._pagination);const n=this._renderPageItem({icon:"icon-arrow-left",disabled:1==i,page:i>1?i-1:null});s.append(this._pagination,n);let a=Math.max(i-5,1),r=Math.min(i+5,e);for(;r-a>4;)i-a>r-i?a++:r--;for(let t=a;t<=r;t++){const e=this._renderPageItem({page:t,active:t==i});s.append(this._pagination,e)}const o=this._renderPageItem({icon:"icon-arrow-right",disabled:i==e,page:i<e?i+1:null});s.append(this._pagination,o)},_renderResults(t){if(s.empty(this._tbody),this._renderHeadings(),this._settings.headerCallback&&this._settings.headerCallback(this._head,this._data||t.results,this._offset,this._offset+this._limit,t.rowIndexes),this._settings.paging&&this._renderPagination(t),this._settings.info&&this._renderInfo(t),t.results.length)for(const[e,i]of t.results.entries()){const t=this._renderRow(i);this._settings.rowCallback&&this._settings.rowCallback(t,i,e,this._offset+e),s.append(this._tbody,t),this._settings.createdRow&&this._settings.createdRow(t,i,e)}else{const t=s.create("tr"),e=s.create("td",{class:"text-center",html:this._term?"No results to show.":"No data to display.",attributes:{colspan:this._columnCount}});s.append(t,e),s.append(this._tbody,t)}this._settings.drawCallback&&this._settings.drawCallback(),this._tfoot&&this._settings.footerCallback&&this._settings.footerCallback(this._tfoot,this._data||t.results,this._offset,this._offset+this._limit,t.rowIndexes)},_renderRow(t){const e=s.create("tr");for(const[i,n]of this._columns.entries()){if(!n.visible)continue;const a=t[n.key||i],r=s.create("td",{html:a});s.append(e,r)}return e},_renderSearch(){const t=s.create("div",{class:"form-input mx-auto me-sm-0",style:{width:"200px"}});this._searchInput=s.create("input",{class:"input-filled input-sm",attributes:{type:"text",placeholder:"Search"}}),s.append(t,this._searchInput);const e=s.create("div",{class:"ripple-line"});s.append(t,e),s.append(this._preCol2,t)}}),Object.assign(n,{_getDataFromDOM(t){const e=s.findOne("tbody",t);return s.children(e,"tr").map(t=>s.children(t,"td").map(t=>s.getHTML(t)))},_getHeadingsFromDOM(t){const e=s.findOne("thead",t),i=s.children(e,"tr").shift();return s.children(i,"th").map(t=>s.getHTML(t))}}),n.defaults={info:!0,lengthChange:!0,ordering:!0,paging:!0,searching:!0,length:10,lengths:[10,25,50,100],order:[[0,"asc"]],columns:null,createdRow:null,drawCallback:null,footerCallback:null,headerCallback:null,infoCallback:null,preDrawCallback:null,rowCallback:null},i.initComponent("table",n),i.Table=n}));